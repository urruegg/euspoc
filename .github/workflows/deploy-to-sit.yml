name: Deploy Solution to SIT

on:
  workflow_dispatch:  # Manual trigger only - no automatic deployments
    inputs:
      artifact_name:
        description: 'Artifact name from build workflow (default: solution-package)'
        required: false
        default: 'solution-package'
      run_id:
        description: 'Build workflow run ID (leave empty for latest)'
        required: false

jobs:
  deploy:
    runs-on: windows-latest
    environment: sit  # Requires environment approval if configured
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false
      
      - name: Setup Power Platform CLI
        shell: pwsh
        run: |
          Write-Host "Installing Power Platform CLI..." -ForegroundColor Cyan
          dotnet tool install --global Microsoft.PowerApps.CLI.Tool
          
          Write-Host "`nVerifying PAC CLI installation..." -ForegroundColor Cyan
          pac
      
      - name: Authenticate to Dataverse
        shell: pwsh
        run: |
          Write-Host "=== Authenticating to Dataverse ===" -ForegroundColor Cyan
          Write-Host "Environment: ${{ secrets.DATAVERSE_URL_SIT }}" -ForegroundColor Yellow
          Write-Host "Using Service Principal: ${{ secrets.AZURE_CLIENT_ID }}" -ForegroundColor Yellow
          
          # Authenticate PAC using GitHub Federation
          pac auth create `
            --environment "${{ secrets.DATAVERSE_URL_SIT }}" `
            --githubFederated `
            --applicationId "${{ secrets.AZURE_CLIENT_ID }}" `
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "PAC authentication failed!"
            exit 1
          }
          
          Write-Host "Authentication successful!" -ForegroundColor Green
      
      - name: Download Solution Package Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.artifact_name || 'solution-package' }}
          path: ./artifact
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify Downloaded Package
        shell: pwsh
        run: |
          Write-Host "=== Solution Package Verification ===" -ForegroundColor Cyan
          $zipPath = "./artifact/solution.zip"
          
          if (Test-Path $zipPath) {
            $zipSize = (Get-Item $zipPath).Length
            Write-Host "Package found: $($zipSize / 1MB) MB" -ForegroundColor Green
          } else {
            Write-Error "Solution package not found!"
            Get-ChildItem ./artifact -Recurse
            exit 1
          }
      
      - name: Get Current Solution Version
        id: get_version
        shell: pwsh
        run: |
          Write-Host "=== Retrieving Current Solution Version ===" -ForegroundColor Cyan
          
          $baseUrl = "${{ secrets.DATAVERSE_URL_SIT }}"
          $apiUrl = "$baseUrl/api/data/v9.2/solutions?`$filter=uniquename eq 'ernaehrungundsportcomponents'&`$select=version,solutionid"
          
          $token = az account get-access-token --resource=$baseUrl --query accessToken -o tsv
          $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
            "OData-MaxVersion" = "4.0"
            "OData-Version" = "4.0"
          }
          
          try {
            $response = Invoke-RestMethod -Uri $apiUrl -Method Get -Headers $headers
            if ($response.value.Count -gt 0) {
              $currentVersion = $response.value[0].version
              Write-Host "Current version: $currentVersion" -ForegroundColor Yellow
              echo "current_version=$currentVersion" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "Solution not found - first deployment" -ForegroundColor Yellow
              echo "current_version=0.0.0.0" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Warning "Could not retrieve current version: $_"
            echo "current_version=unknown" >> $env:GITHUB_OUTPUT
          }
      
      - name: Import Solution to Dataverse
        shell: pwsh
        run: |
          Write-Host "=== Importing Solution to Dataverse ===" -ForegroundColor Cyan
          Write-Host "Environment: ${{ secrets.DATAVERSE_URL_SIT }}" -ForegroundColor Cyan
          Write-Host "Current Version: ${{ steps.get_version.outputs.current_version }}" -ForegroundColor Cyan
          
          pac solution import `
            --path "./artifact/solution.zip" `
            --force-overwrite `
            --publish-changes `
            --skip-dependency-check
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Solution import failed!"
            exit 1
          }
          
          Write-Host "Solution import completed successfully!" -ForegroundColor Green
      
      - name: Verify Import Completion
        shell: pwsh
        run: |
          Write-Host "=== Verifying Import Result ===" -ForegroundColor Cyan
          Write-Host "Import completed by PAC CLI (synchronous operation)" -ForegroundColor Green
          Write-Host "Solution has been imported and all customizations published." -ForegroundColor Green
      
      - name: Verify Deployment
        shell: pwsh
        run: |
          Write-Host "=== Deployment Verification ===" -ForegroundColor Cyan
          
          $baseUrl = "${{ secrets.DATAVERSE_URL_SIT }}"
          $apiUrl = "$baseUrl/api/data/v9.2/solutions?`$filter=uniquename eq 'ernaehrungundsportcomponents'&`$select=version,friendlyname,installedon,modifiedon"
          
          $token = az account get-access-token --resource=$baseUrl --query accessToken -o tsv
          $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
            "OData-MaxVersion" = "4.0"
            "OData-Version" = "4.0"
          }
          
          try {
            $response = Invoke-RestMethod -Uri $apiUrl -Method Get -Headers $headers
            
            if ($response.value.Count -gt 0) {
              $solution = $response.value[0]
              
              Write-Host "=== Deployed Solution Details ===" -ForegroundColor Green
              Write-Host "Name: $($solution.friendlyname)" -ForegroundColor White
              Write-Host "Version: $($solution.version)" -ForegroundColor White
              Write-Host "Installed On: $($solution.installedon)" -ForegroundColor White
              Write-Host "Modified On: $($solution.modifiedon)" -ForegroundColor White
              Write-Host ""
              Write-Host "Previous Version: ${{ steps.get_version.outputs.current_version }}" -ForegroundColor Yellow
              Write-Host ""
              Write-Host "âœ… Deployment verified successfully!" -ForegroundColor Green
            } else {
              Write-Error "Solution not found in Dataverse after import!"
              exit 1
            }
          } catch {
            Write-Error "Verification failed: $_"
            exit 1
          }
      
      - name: Create Deployment Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸš€ Deployment Summary
          
          **Environment:** SIT (System Integration Testing)
          **Solution:** ernaehrungundsportcomponents
          **Status:** ${{ job.status }}
          
          ### Version Information
          - **Previous Version:** ${{ steps.get_version.outputs.current_version }}
          - **Deployment Time:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          
          ### Environment Details
          - **Dataverse URL:** ${{ secrets.DATAVERSE_URL_SIT }}
          - **Tenant ID:** ${{ secrets.DATAVERSE_TENANT_ID_SIT }}
          - **Service Principal:** ${{ secrets.DATAVERSE_CLIENT_ID_SIT }}
          
          ### Next Steps
          1. Verify control appears in solution components
          2. Test control on ur_nutritioncounselling form
          3. Validate data binding and functionality
          
          "@
          
          echo $summary >> $env:GITHUB_STEP_SUMMARY
